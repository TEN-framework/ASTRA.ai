#!/bin/bash

set -e

cd "$(dirname "${BASH_SOURCE[0]}")/.."

# python3 -m venv .
# cd bin
# source activate
# cd ..

if [[ -f "requirements.txt" ]]; then
  pip install -r requirements.txt
fi

# traverse the addon/extension directory to find the requirements.txt
if [[ -d "addon/extension" ]]; then
  for extension in addon/extension/*; do
    if [[ -f "$extension/requirements.txt" ]]; then
      pip install -r $extension/requirements.txt
    fi
  done
fi

# if [[ -f "lib/libclang_rt.asan_osx_dynamic.dylib" ]]; then
#   export DYLD_INSERT_LIBRARIES=lib/libclang_rt.asan_osx_dynamic.dylib
# fi

# if [[ -f "lib/libasan.so" ]]; then
#   export LD_PRELOAD=lib/libasan.so
# fi

export PYTHONPATH=lib:interface
export RTE_HOME=.
# export PYTHONMALLOC=malloc

python3 main.py
